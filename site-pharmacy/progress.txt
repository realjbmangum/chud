# Site Pharmacy - Progress Log

## Project Overview
Independent pharmacy directory to help consumers find pharmacies not owned by CVS/Walgreens/chains and avoid pharmacy-insurance conflicts of interest.

**Domain:** TBD (check availability)
**Database:** Cloudflare D1 (SQLite)
**Hosting:** Cloudflare Pages
**Framework:** Astro + Tailwind CSS

---

## Session - January 29, 2026

**Completed:**
- Created PRD analyzing market opportunity and viability
- Decided on D1 database instead of Supabase
- Created site-pharmacy folder structure
- Created initial progress.txt

**Key Decisions:**
- **Database:** Using Cloudflare D1 (SQLite) instead of Supabase PostgreSQL
  - Rationale: All-in on Cloudflare stack, simpler deployment, local dev with Wrangler
  - Trade-off: No RLS (will use Cloudflare Access for admin pages)
- **MVP Scope:** Top 20 metro areas first (not all 50 states)
  - Validate market before scaling nationally
- **Data Source:** NPI Registry + name-based chain filtering
  - Skip corporate health plan data for MVP (too hard to verify)
- **Revenue Model:** Premium listings + GoodRx affiliate + ads

**Viability Grade:** B+ (GO with scoped MVP)

**Completed This Session:**
- ✅ Created comprehensive PRD with viability analysis (Grade: B+ - GO)
- ✅ Set up Astro site structure with Cloudflare D1
- ✅ Created D1 database schema (SQLite syntax)
- ✅ Built website mockup with key pages
- ✅ Created reusable components (PharmacyCard, SearchBar)
- ✅ Implemented submission form with API endpoint
- ✅ Documented D1 workflow and differences from PostgreSQL

**Next Steps:**
- [ ] Check domain availability (independentpharmacies.com, localpharmacyfinder.com, independentrx.com)
- [ ] Create D1 database: `npm run db:create`
- [ ] Apply migrations: `npm run db:migrate:local`
- [ ] Download NPI Registry data (CSV)
- [ ] Process and filter for independent pharmacies (exclude chains)
- [ ] Import top 1,000 pharmacies (20 metros)
- [ ] Deploy to Cloudflare Pages
- [ ] Connect domain and configure DNS

**Files Created:**
- site-pharmacy/PRD.md
- site-pharmacy/progress.txt
- site-pharmacy/CLAUDE.md
- site-pharmacy/README.md
- site-pharmacy/package.json
- site-pharmacy/wrangler.toml
- site-pharmacy/astro.config.mjs
- site-pharmacy/tailwind.config.mjs
- site-pharmacy/tsconfig.json
- site-pharmacy/migrations/0001_init_schema.sql
- site-pharmacy/src/layouts/BaseLayout.astro
- site-pharmacy/src/components/PharmacyCard.astro
- site-pharmacy/src/components/SearchBar.astro
- site-pharmacy/src/pages/index.astro
- site-pharmacy/src/pages/browse.astro
- site-pharmacy/src/pages/why-independent.astro
- site-pharmacy/src/pages/submit.astro
- site-pharmacy/functions/api/submit.ts
- site-pharmacy/.gitignore

---

## Codebase Patterns

### Database (D1 - SQLite)

**Key Differences from PostgreSQL:**
- Use `INTEGER PRIMARY KEY` instead of `UUID` (SQLite auto-increment)
- Use `TEXT` instead of `VARCHAR`
- No arrays - use JSON or separate tables
- No `JSONB` - use `TEXT` with JSON string
- No native geospatial - calculate distance in application layer

**Connection Pattern:**
```typescript
// In Cloudflare Pages Functions
export const onRequest: PagesFunction<Env> = async (context) => {
  const db = context.env.DB; // D1 binding
  const results = await db.prepare('SELECT * FROM pharmacies').all();
  return new Response(JSON.stringify(results));
};
```

**Migration Pattern:**
```bash
# Create migration
npx wrangler d1 migrations create pharmacy-db init

# Apply migration
npx wrangler d1 migrations apply pharmacy-db --local
npx wrangler d1 migrations apply pharmacy-db --remote
```

### Astro Configuration for D1

**wrangler.toml:**
```toml
[[d1_databases]]
binding = "DB"
database_name = "pharmacy-db"
database_id = "xxx"
```

**astro.config.mjs:**
```javascript
export default defineConfig({
  output: 'hybrid', // or 'server' for full SSR
  adapter: cloudflare(),
});
```

---

## Gotchas

1. **D1 has no UUID type** - Use INTEGER PRIMARY KEY (auto-increment) or TEXT with generated UUID
2. **No array columns** - Store services_offered as JSON string, parse in app
3. **D1 Local vs Remote** - Always test migrations locally first, then apply to remote
4. **Geolocation** - Calculate distance in JS (Haversine formula), can't use PostGIS functions

---
